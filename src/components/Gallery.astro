---
import { cld, getCldThumb } from '../lib/cloudinary'

const { images, slug } = Astro.props
---

<section class="gallery" data-slug={slug} data-count={images?.length ?? 0}>
  {images && images.length > 0 ? (
    images.map((id: string, index: number) => (
      <figure class="gallery-item">
        <img
          src={cld(id, slug, { width: 400, quality: 'auto' })}
          loading="lazy"
          decoding="async"
          alt=""
          data-index={index}
          class="gallery-image"
        />
      </figure>
    ))
  ) : (
    <div class="no-images">No images found for this series.</div>
  )}
</section>

<div id="lightbox" class="lightbox">
  <button class="lightbox-close" aria-label="Close">&times;</button>
  <div class="lightbox-content">
    <div class="lightbox-image-wrapper">
      <img id="lightbox-image" src="" alt="" />
      <div class="lightbox-loading"></div>
    </div>
  </div>
  <button class="lightbox-prev" aria-label="Previous">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>
  <button class="lightbox-next" aria-label="Next">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </button>
</div>

<style>
  .gallery {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  .gallery-item {
    margin: 0;
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    background: #0f1114;
    cursor: pointer;
  }

  .gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    aspect-ratio: 4 / 3;
    transition: transform 300ms ease;
  }

  .no-images {
    padding: 6rem 1rem;
    text-align: center;
    color: var(--fg);
    background: transparent;
    min-height: 220px;
  }

  .gallery-item:hover img {
    transform: scale(1.03);
  }

  .lightbox {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(5, 6, 7, 0.95);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
  }

  .lightbox.active {
    display: flex;
  }

  .lightbox-content {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    padding: 4rem;
    overflow: hidden;
  }

  .lightbox-image-wrapper {
    position: relative;
    max-width: calc(100% - 120px);
    max-height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #lightbox-image {
    max-width: 80vw;
    max-height: 90vh;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 8px;
    transition: opacity 200ms ease;
    position: relative;
    z-index: 1;
  }

  .lightbox-loading {
    position: absolute;
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    opacity: 0;
    transition: opacity 200ms ease;
    z-index: 2;
  }

  .lightbox-loading.active {
    opacity: 1;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @media (max-width: 1024px) {
    .gallery {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .lightbox-content {
      padding: 2rem 1rem;
    }

    .lightbox-image-wrapper {
      max-width: 95vw;
    }

    #lightbox-image {
      max-width: 95vw;
      max-height: 80vh;
    }
  }

  @media (max-width: 768px) {
    .gallery {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.8rem;
    }

    .gallery-item img {
      aspect-ratio: 3 / 2;
    }

    .lightbox-prev,
    .lightbox-next {
      width: 36px;
      height: 36px;
      font-size: 0.8rem;
    }

    .lightbox-prev {
      left: 0.5rem;
    }

    .lightbox-next {
      right: 0.5rem;
    }
  }

  @media (max-width: 480px) {
    .gallery {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }

    .lightbox-close {
      width: 36px;
      height: 36px;
      font-size: 1.5rem;
      top: 1rem;
      right: 1rem;
    }

    #lightbox-image {
      max-width: 90vw;
      max-height: 70vh;
    }
  }

  .lightbox-close,
  .lightbox-prev,
  .lightbox-next {
    position: absolute;
    background: transparent;
    border: none;
    color: var(--fg);
    cursor: pointer;
    transition: color 140ms ease;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    width: 48px;
    height: 48px;
  }

  .lightbox-close:hover,
  .lightbox-prev:hover,
  .lightbox-next:hover {
    color: var(--accent);
  }

  .lightbox-close {
    top: 2rem;
    right: 2rem;
    z-index: 1001;
    font-size: 2.4rem;
    line-height: 1;
  }

  .lightbox-prev {
    left: 2rem;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1002;
  }

  .lightbox-next {
    right: 2rem;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1002;
  }

  @media (max-width: 768px) {
    .gallery {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .lightbox-content {
      padding: 2rem 1rem;
    }

    #lightbox-image {
      max-width: 95vw;
      max-height: 60vh;
    }

    .lightbox-close {
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
    }
  }
</style>

<script>
  const setupGallery = () => {
    const gallery = document.querySelector('.gallery') as HTMLElement | null
    const lightbox = document.getElementById('lightbox') as HTMLElement | null
    const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement | null
    const lightboxClose = document.querySelector('.lightbox-close')
    const lightboxPrev = document.querySelector('.lightbox-prev')
    const lightboxNext = document.querySelector('.lightbox-next')
    const lightboxLoading = document.querySelector('.lightbox-loading') as HTMLElement
    
    let currentIndex = 0
    let allImages: string[] = []
    const slug = gallery?.dataset.slug || ''
    const CLOUD_NAME = 'mathis-portfolio'
    const imageCache = new Map<string, string>()

    // Sammle alle Bilder aus den data-index Attributen
    const updateAllImages = () => {
      allImages = Array.from(document.querySelectorAll('.gallery-image'))
        .map((img, index) => {
          const imageId = (img as HTMLImageElement).src.split('/').pop()?.split('?')[0] || ''
          return imageId
        })
        .filter(Boolean)
    }
    
    updateAllImages()

    const cldUrl = (imageId: string, options?: any) => {
      const transforms = []
      if (options?.width) transforms.push(`w_${options.width}`)
      transforms.push(options?.quality ? `q_${options.quality}` : 'q_auto')
      transforms.push('f_webp')
      const transformString = transforms.length > 0 ? `/${transforms.join('/')}` : ''
      return `https://res.cloudinary.com/${CLOUD_NAME}/image/upload${transformString}/portfolio/${slug}/${imageId}`
    }

  // Preload images for smoother transitions
    const preloadImage = (imageId: string) => {
      if (imageCache.has(imageId)) return
      const img = new Image()
      img.src = cldUrl(imageId, { width: 1400, quality: 'auto' })
      img.onload = () => {
        imageCache.set(imageId, img.src)
      }
      img.onerror = () => {
        // Still mark as cached even on error to avoid retrying
        imageCache.set(imageId, '')
      }
    }

    // Preload all images in the background
    const preloadAllImages = () => {
      allImages.forEach((imageId, index) => {
        // Don't preload too many at once to avoid overwhelming the connection
        // Skip if already being used in gallery
        setTimeout(() => {
          preloadImage(imageId)
        }, index * 150) // Stagger preloads by 150ms (faster)
      })
    }

    const openLightbox = (index: number) => {
      if (!lightbox || !lightboxImage) return
      if (index < 0 || index >= allImages.length) return
      
      currentIndex = index
      lightbox.classList.add('active')
      const imageId = allImages[index]
      
      // Load full resolution image
      lightboxImage.src = cldUrl(imageId, { width: 1400, quality: 'auto' })
      lightboxImage.style.opacity = '0'
      lightboxLoading?.classList.add('active')
      
      lightboxImage.onload = () => {
        lightboxImage.style.opacity = '1'
        lightboxLoading?.classList.remove('active')
      }
      
      document.body.style.overflow = 'hidden'
      
      // Preload next and prev images
      if (index + 1 < allImages.length) {
        preloadImage(allImages[index + 1])
      }
      if (index - 1 >= 0) {
        preloadImage(allImages[index - 1])
      }
    }

    const closeLightbox = () => {
      if (!lightbox) return
      lightbox.classList.remove('active')
      document.body.style.overflow = ''
    }

    const showNext = () => {
      if (allImages.length === 0) return
      currentIndex = (currentIndex + 1) % allImages.length
      if (lightboxImage) {
        const imageId = allImages[currentIndex]
        
        // Don't reload if already loading this image
        if (lightboxImage.src.includes(imageId)) return
        
        lightboxImage.src = cldUrl(imageId, { width: 1400, quality: 'auto' })
        lightboxImage.style.opacity = '0'
        lightboxLoading?.classList.add('active')
        
        lightboxImage.onload = () => {
          lightboxImage.style.opacity = '1'
          lightboxLoading?.classList.remove('active')
        }
        
        // Preload next image
        if (currentIndex + 1 < allImages.length) {
          preloadImage(allImages[currentIndex + 1])
        }
      }
    }

    const showPrev = () => {
      if (allImages.length === 0) return
      currentIndex = (currentIndex - 1 + allImages.length) % allImages.length
      if (lightboxImage) {
        const imageId = allImages[currentIndex]
        
        // Don't reload if already loading this image
        if (lightboxImage.src.includes(imageId)) return
        
        lightboxImage.src = cldUrl(imageId, { width: 1400, quality: 'auto' })
        lightboxImage.style.opacity = '0'
        lightboxLoading?.classList.add('active')
        
        lightboxImage.onload = () => {
          lightboxImage.style.opacity = '1'
          lightboxLoading?.classList.remove('active')
        }
        
        // Preload previous image
        if (currentIndex - 1 >= 0) {
          preloadImage(allImages[currentIndex - 1])
        }
      }
    }

    // Setup gallery image clicks
    const setupImageClicks = () => {
      document.querySelectorAll('.gallery-image').forEach((img) => {
        const imgElement = img as HTMLImageElement
        if (!imgElement.dataset.clickHandlerAttached) {
          imgElement.addEventListener('click', () => {
            const index = Array.from(document.querySelectorAll('.gallery-image')).indexOf(img)
            openLightbox(index)
          })
          imgElement.dataset.clickHandlerAttached = 'true'
        }
      })
    }
    
    setupImageClicks()

    // Button-Klicks
    lightboxClose?.addEventListener('click', (e) => {
      e.preventDefault()
      e.stopPropagation()
      closeLightbox()
    })
    
    lightboxPrev?.addEventListener('click', (e) => {
      e.preventDefault()
      e.stopPropagation()
      showPrev()
    })
    
    lightboxNext?.addEventListener('click', (e) => {
      e.preventDefault()
      e.stopPropagation()
      showNext()
    })

    // Hintergrund-Klick
    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox) closeLightbox()
    })

    // Keyboard-Navigation
    document.addEventListener('keydown', (e) => {
      if (!lightbox || !lightbox.classList.contains('active')) return
      if (e.key === 'Escape') closeLightbox()
      if (e.key === 'ArrowRight') showNext()
      if (e.key === 'ArrowLeft') showPrev()
    })
    
    // Start preloading images immediately for faster loading
    preloadAllImages()
  }

  // Beim Laden und bei Navigation
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupGallery)
  } else {
    setupGallery()
  }

  // FÃ¼r Astro View Transitions
  document.addEventListener('astro:after-swap', setupGallery)
</script>
