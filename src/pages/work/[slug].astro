---
import '../../styles/global.css'
import '../../styles/work.css'
import BaseLayout from '../../layouts/BaseLayout.astro'
import Gallery from '../../components/Gallery.astro'
import { getAllSeries, getSeriesBySlug } from '../../lib/queries'
import { getCloudinaryImages } from '../../lib/cloudinary'

export async function getStaticPaths() {
  const series = await getAllSeries()
  return series.map((s) => ({
    params: { slug: s.slug },
  }))
}

const { slug } = Astro.params
const series = await getSeriesBySlug(slug!)
const images = await getCloudinaryImages(slug!)
// Shuffle images randomly
const shuffledImages = [...images].sort(() => Math.random() - 0.5)
const allSeries = await getAllSeries()
const seriesIndex = allSeries.findIndex((s) => s.slug === slug)
const prevSeries = allSeries[(seriesIndex - 1 + allSeries.length) % allSeries.length]
const nextSeries = allSeries[(seriesIndex + 1) % allSeries.length]

if (!series) {
  throw new Error(`Series not found for slug: ${slug}`)
}
---

<BaseLayout title={`${series.title} · Mathis Heck`} description={series.description || `Photo series ${series.title} by Mathis Heck`}>

  <main>
    <div class="header">
      <a href="/" class="home-link">Home</a>
      <div style="margin-top: 2rem;">
        <div class="series-nav">
          <a
            class="series-nav-link"
            href={`/work/${prevSeries?.slug}`}
            aria-label="Previous series"
            title="Previous series"
          >
            <span aria-hidden="true">←</span>
          </a>
          <div class="series-header-content">
            <h1 class="detail-title">{series.title}</h1>
            {series.year && <div class="meta"><span>{series.year}</span></div>}
            {series.description && <p class="description">{series.description}</p>}
          </div>
          <a
            class="series-nav-link"
            href={`/work/${nextSeries?.slug}`}
            aria-label="Next series"
            title="Next series"
          >
            <span aria-hidden="true">→</span>
          </a>
        </div>
      </div>
    </div>

    <Gallery images={shuffledImages} slug={series.slug} />

    <button id="back-to-top" class="back-to-top" aria-label="Back to top">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="18 15 12 9 6 15"></polyline>
      </svg>
    </button>
  </main>
</BaseLayout>

<style is:global>
  .back-to-top {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(245, 245, 247, 0.15);
    border: 2px solid rgba(245, 245, 247, 0.4);
    color: var(--fg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 200ms ease;
    opacity: 0;
    visibility: hidden;
    z-index: 999;
  }

  .back-to-top.visible {
    opacity: 1;
    visibility: visible;
  }

  .back-to-top:hover {
    background: rgba(245, 245, 247, 0.25);
    border-color: rgba(245, 245, 247, 0.6);
    transform: translateX(-50%) translateY(-6px);
    box-shadow: 0 8px 24px rgba(245, 245, 247, 0.15);
  }

  @media (max-width: 768px) {
    .back-to-top {
      bottom: 1.5rem;
      width: 52px;
      height: 52px;
    }
  }
</style>

<script>
  function setupBackToTop() {
    const backToTopBtn = document.getElementById('back-to-top') as HTMLButtonElement

    if (!backToTopBtn) return

    function updateBackToTopVisibility() {
      if (window.scrollY > 300) {
        backToTopBtn.classList.add('visible')
      } else {
        backToTopBtn.classList.remove('visible')
      }
    }

    window.addEventListener('scroll', updateBackToTopVisibility)
    backToTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' })
    })
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupBackToTop)
  } else {
    setupBackToTop()
  }

  document.addEventListener('astro:after-swap', setupBackToTop)
</script>
