---
import '../styles/global.css'
import '../styles/work.css'
import BaseLayout from '../layouts/BaseLayout.astro'
import { getAllSeries } from '../lib/queries'
import { getCloudinaryImages, cld, getCldThumb } from '../lib/cloudinary'

const series = await getAllSeries()

// Alle Bilder von allen Serien sammeln
const allImagesWithSlugs = await Promise.all(
  series.map(async (s) => {
    const images = await getCloudinaryImages(s.slug)
    return images.map(id => ({ id, slug: s.slug }))
  })
)

// Flatten array
const allImages = allImagesWithSlugs.flat()
---

<BaseLayout title="All Images Â· Mathis Heck" description="All photographs by Mathis Heck">
  <main>
    <div class="header">
      <h1 class="detail-title">All Images</h1>
      <p class="description">All photographs from all series</p>
    </div>

    <section class="gallery" data-all="true">
      {allImages.map((item, index) => (
        <figure class="gallery-item">
          <img
            src={cld(item.id, item.slug, { width: 400, quality: 'auto' })}
            loading="lazy"
            decoding="async"
            alt=""
            data-index={index}
            data-id={item.id}
            data-slug={item.slug}
            data-full-url={cld(item.id, item.slug, { width: 1400, quality: 'auto' })}
            data-thumb-url={getCldThumb(item.id, item.slug)}
            class="gallery-image"
          />
        </figure>
      ))}
    </section>

    <div id="lightbox" class="lightbox">
      <button class="lightbox-close" aria-label="Close">&times;</button>
      <div class="lightbox-content">
        <div class="lightbox-image-wrapper">
          <img id="lightbox-blur" src="" alt="" class="lightbox-blur" />
          <img id="lightbox-image" src="" alt="" />
          <div class="lightbox-loading"></div>
        </div>
      </div>
      <button class="lightbox-arrow lightbox-prev" aria-label="Previous">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <button class="lightbox-arrow lightbox-next" aria-label="Next">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>
  </main>
</BaseLayout>

<script>
  function setupGallery() {
    const galleryImages = document.querySelectorAll('.gallery-image')
    const lightbox = document.getElementById('lightbox')
    const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement
    const lightboxBlur = document.getElementById('lightbox-blur') as HTMLImageElement
    const closeBtn = document.querySelector('.lightbox-close')
    const prevBtn = document.querySelector('.lightbox-prev')
    const nextBtn = document.querySelector('.lightbox-next')
    
    let currentIndex = 0
    const allImages: Array<{ id: string, slug: string, fullUrl: string, thumbUrl: string }> = []
    
    galleryImages.forEach((img) => {
      const imageId = img.getAttribute('data-id')!
      const imageSlug = img.getAttribute('data-slug')!
      const fullUrl = img.getAttribute('data-full-url')!
      const thumbUrl = img.getAttribute('data-thumb-url')!
      allImages.push({ id: imageId, slug: imageSlug, fullUrl, thumbUrl })
    })

    function getThumbUrl(item: any): string {
      // Return the thumb URL that was pre-generated at build time
      return item.thumbUrl
    }

    function openLightbox(index: number) {
      currentIndex = index
      const item = allImages[currentIndex]
      
      lightbox?.classList.add('active')
      document.body.style.overflow = 'hidden'
      document.body.style.touchAction = 'none'
      
      // Show blur placeholder immediately
      lightboxBlur.src = item.thumbUrl
      lightboxBlur.style.opacity = '1'
      lightboxImage.style.opacity = '0'
      
      // Show loading spinner only after 1 second delay
      const loader = document.querySelector('.lightbox-loading') as HTMLElement
      loader.style.display = 'none'
      const loaderTimeout = setTimeout(() => {
        loader.style.display = 'block'
      }, 1000)
      
      // Load full resolution
      const fullImg = new Image()
      fullImg.onload = () => {
        clearTimeout(loaderTimeout)
        lightboxImage.src = fullImg.src
        lightboxImage.style.opacity = '1'
        lightboxBlur.style.opacity = '0'
        loader.style.display = 'none'
      }
      fullImg.src = item.fullUrl
    }

    function closeLightbox() {
      lightbox?.classList.remove('active')
      document.body.style.overflow = ''
      document.body.style.touchAction = ''
    }

    function showNext() {
      currentIndex = (currentIndex + 1) % allImages.length
      const item = allImages[currentIndex]
      
      lightboxBlur.src = item.thumbUrl
      lightboxBlur.style.opacity = '1'
      lightboxImage.style.opacity = '0'
      
      const loader = document.querySelector('.lightbox-loading') as HTMLElement
      loader.style.display = 'none'
      const loaderTimeout = setTimeout(() => {
        loader.style.display = 'block'
      }, 1000)
      
      const fullImg = new Image()
      fullImg.onload = () => {
        clearTimeout(loaderTimeout)
        lightboxImage.src = fullImg.src
        lightboxImage.style.opacity = '1'
        lightboxBlur.style.opacity = '0'
        loader.style.display = 'none'
      }
      fullImg.src = item.fullUrl
    }

    function showPrev() {
      currentIndex = (currentIndex - 1 + allImages.length) % allImages.length
      const item = allImages[currentIndex]
      
      lightboxBlur.src = item.thumbUrl
      lightboxBlur.style.opacity = '1'
      lightboxImage.style.opacity = '0'
      
      const loader = document.querySelector('.lightbox-loading') as HTMLElement
      loader.style.display = 'none'
      const loaderTimeout = setTimeout(() => {
        loader.style.display = 'block'
      }, 1000)
      
      const fullImg = new Image()
      fullImg.onload = () => {
        clearTimeout(loaderTimeout)
        lightboxImage.src = fullImg.src
        lightboxImage.style.opacity = '1'
        lightboxBlur.style.opacity = '0'
        loader.style.display = 'none'
      }
      fullImg.src = item.fullUrl
    }

    // Event listeners
    galleryImages.forEach((img, index) => {
      img.addEventListener('click', () => openLightbox(index))
    })
    
    closeBtn?.addEventListener('click', closeLightbox)
    prevBtn?.addEventListener('click', showPrev)
    nextBtn?.addEventListener('click', showNext)
    
    // Prevent scrolling when lightbox is open
    document.addEventListener('wheel', (e) => {
      if (lightbox?.classList.contains('active')) {
        e.preventDefault()
      }
    }, { passive: false })
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (!lightbox?.classList.contains('active')) return
      
      if (e.key === 'Escape') closeLightbox()
      if (e.key === 'ArrowLeft') showPrev()
      if (e.key === 'ArrowRight') showNext()
    })

    // Preload only next/prev images when lightbox is open
    function preloadAdjacentImages() {
      const nextIndex = (currentIndex + 1) % allImages.length
      const prevIndex = (currentIndex - 1 + allImages.length) % allImages.length
      
      const nextItem = allImages[nextIndex]
      const prevItem = allImages[prevIndex]
      
      const nextImg = new Image()
      nextImg.src = nextItem.fullUrl
      
      const prevImg = new Image()
      prevImg.src = prevItem.fullUrl
    }

    // Preload adjacent images after opening lightbox
    const originalOpenLightbox = openLightbox
    const wrappedOpenLightbox = (index: number) => {
      originalOpenLightbox(index)
      setTimeout(() => preloadAdjacentImages(), 500)
    }
    Object.assign(window, { openLightbox: wrappedOpenLightbox })
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupGallery)
  } else {
    setupGallery()
  }

  document.addEventListener('astro:after-swap', setupGallery)
</script>

<style>
  .gallery {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    margin: 2rem 0;
  }

  .gallery-item {
    margin: 0;
    aspect-ratio: 3 / 2;
    overflow: hidden;
    border-radius: 8px;
    background: #0f1114;
  }

  .gallery-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
    transition: transform 200ms ease, opacity 200ms ease;
  }

  .gallery-image:hover {
    transform: scale(1.02);
  }

  .lightbox {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(5, 6, 7, 0.95);
    z-index: 1000;
    backdrop-filter: blur(8px);
  }

  .lightbox.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox-close {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    background: rgba(245, 245, 247, 0.1);
    border: 1px solid var(--border);
    color: var(--fg);
    width: 44px;
    height: 44px;
    border-radius: 50%;
    font-size: 1.8rem;
    cursor: pointer;
    z-index: 1001;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 140ms ease;
  }

  .lightbox-close:hover {
    background: rgba(245, 245, 247, 0.2);
  }

  .lightbox-content {
    max-width: 80vw;
    max-height: 90vh;
    position: relative;
  }

  .lightbox-image-wrapper {
    position: relative;
    max-width: 80vw;
    max-height: 90vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  #lightbox-image,
  #lightbox-blur {
    max-width: 80vw;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 8px;
    transition: opacity 300ms ease;
  }

  #lightbox-blur {
    position: absolute;
    filter: blur(20px);
    z-index: 1;
  }

  #lightbox-image {
    position: relative;
    z-index: 1;
  }

  .lightbox-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border: 3px solid rgba(245, 245, 247, 0.3);
    border-top-color: var(--fg);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    z-index: 2;
    display: none;
  }

  @keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }

  .lightbox-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(245, 245, 247, 0.1);
    border: 1px solid var(--border);
    color: var(--fg);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 140ms ease;
    z-index: 1002;
  }

  .lightbox-arrow:hover {
    background: rgba(245, 245, 247, 0.2);
  }

  .lightbox-prev {
    left: 2rem;
  }

  .lightbox-next {
    right: 2rem;
  }

  @media (max-width: 768px) {
    .gallery {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.5rem;
    }

    .lightbox-arrow {
      width: 40px;
      height: 40px;
    }

    .lightbox-prev {
      left: 1rem;
    }

    .lightbox-next {
      right: 1rem;
    }
  }
</style>
